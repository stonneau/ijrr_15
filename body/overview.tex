% !TEX root =  ../main.tex
\section{Overview}
\label{overview}

Figure~\ref{fig:framework} illustrates our workflow.
\Pa and \Pb are addressed in a sequential fashion.
The guarantees provided by the \textit{geometrically feasible} guide path allow
us to avoid the combinatorial by generating the contacts in a straightforward manner.



%
\begin{figure*}
  \centering
  \begin{overpic}[width=0.8\linewidth]{figures/contact_gen}
		\put (1,1) {a} 
		\put (22,1) {b} 
		\put (42,1) {c} 
		\put (62,1) {d} 
		\put (83,1) {e} 
	\end{overpic}
  \caption{Generation of a contact configuration for the right leg of HRP-2. a: Selection of reachable obstacles. b: Entries of the limb samples database (with $N = 4$). c: With a proximity query on the octree database, configurations too far from obstacles are eliminated. d: The best candidate according to a user-defined heuristic $h$ is chosen. e: The final contact is achieved using inverse kinematics.}
  \label{fig:contact_gen}
\end{figure*}
\subsection{Computation of a guide path --- \Pa}
We first consider the problem of planning a relevant guide path. The objective is to compute a path of root placements that will allow contact creation. A desired requirement is to preserve the completeness of the planner: it should be able to explore any possible guide path, but at the same time, any computed guide path must be \textit{truly feasible}, i.e. must lead to a valid sequence of contacts.

More precisely, a root placement is \textit{truly feasible} if and only if there exists at least one joint configuration such that the robot satisfies three conditions:
\begin{description}
\item[C1] is not in collision with the environment, 
\item[C2] has at least one end-effector in contact with the environment, 
\item[C3] is in static equilibrium. 
\end{description}
C1 and C2 define \textit{geometrical feasibility}, and can be efficiently approximated even without computing the contact points. C3 defines \textit{equilibrium feasibility}. C3 is difficult to approximate and requires the computation of the contact points, as well as the resolution of a linear program to compute the contact forces~\citep{Prete2016}. 
However our intuition suggests us that, for cluttered environments, verifying C3 is not critical for $\mathcal{P}_1$, meaning that, most of the times, root placements satisfying C1 and C2 would satisfy also C3. For this reason we neglect C3 during the resolution of \Pa, and we worry about it only when solving \Pb.

An intuitive description of root placements satisfying C1 and C2 is ``close, but not too close'': close, because a contact surface must be partially included in the reachable workspace of the robot (represented for the right arm in Figure~\ref{fig:contact_gen}--a); not too close, because the robot must avoid collision. We define formally $C_{reach}$, the set of root placements satisfying C1 and C2, in which we compute a guide path with a sampling-based planner, the Reachability-Based RRT---RB-RRT--- (Figure~\ref{fig:framework}---\Pa). Planning in $C_{reach}$ boils down to planning in SE(3), which has an acceptable practical complexity.
%
Details are presented in Section~\ref{rbprm}.

\subsection{Generating a discrete sequence of contact configurations --- \Pb}

The second stage extends the guide path into a sequence of contact configurations (Figure~\ref{fig:framework}--\Pb). In this
step the input guide path is \textit{geometrically feasible}.
With a fixed root position, the dimensionality of the 
contact generation problem is reduced to the number of degrees of freedom of the considered limb. In other words, we consider each limb as a manipulator attached to the root, and select the most relevant contact from a database of precomputed configurations, which is independent from the environment (Figure~\ref{fig:contact_gen}).

From a given start configuration, the planner proceeds in an iterative fashion along the discretized path: given a new root placement, an inverse-kinematics solver 
is used to maintain the contacts that were previously existing. Often, these contacts cannot be maintained, because of joint limits or collisions.
In such a case the contacts are broken. Conversely, new contacts are created to ensure the static equilibrium of the robot.
The algorithm is designed so that only one contact can be created or broken between two successive configurations. This ensures that the interpolation between two configurations is achievable.
Details are presented in Section~\ref{sec:contact}. 

To select the ``most relevant'' contact configurations, user-defined heuristics can be chosen. In Section~\ref{sec:heuristics} we present extensively two such heuristics, which have been used in our experiments.


%~ To create a contact, we consider each limb of the robot as a manipulator arm attached to the root. We store a database of configurations for each manipulator. Figure~\ref{fig:contact_gen} -- 2 presents a few configurations for the right arm of the robot. The configurations in the database which are close to contact are considered (Figure~\ref{fig:contact_gen} -- 2 and 3). Among the candidates, 3 criteria are considered to choose the most relevant: the ideal candidate is free of collision, allows to maintain static balance if necessary, and  contributes to the motion in an optimal way. We call the measure of this contribution task efficiency: it represents the ability the limb has to exert a force compatible with the direction of motion. In Figure~\ref{fig:contact_gen} -- 4, the black arrow represents the direction of motion. Among the candidates, the most relevant to achieve a vertical motion is chosen, and projected on the contact surface using an inverse kinematics solver (Figure~\ref{fig:contact_gen} -- 5). The task efficiency is measured using the Extended FORce Transmission ratio (EFORT), proposed by ~\cite{Tonneau:2014:TEC:2619648.2619652}.

\subsection{Notation conventions and definitions} \label{notations}

A vector  $\mathbf{x}$ is denoted with a bold lower-case letter.
A matrix $\mathbf{A}$ is denoted with a bold upper-case letter.
A set $C$ is denoted with an upper-case italic letter.
Scalar variables and functions are denoted with lower-case italic letters, such as
$r$ or $f(\textbf{x})$.

%\subsubsection{Robot description}
%\label{def}

\begin{figure}
  \centering
  \begin{overpic}[width=0.8\linewidth]{figures/character}
    \put (7,29) {\small{$\in \mathbf{q}^1$}}
    \put (7,25) {\small{effector}}
  \end{overpic}
  \caption{
    Left: Robot in a rest configuration. The right arm is denoted as the limb $R^1$. Each colored dot represents a degree of freedom around an axis. Right: Volumes of the robot. The red geometry denotes $W^0$ and must remain collision-free. The green spheres are the reachable workspace of each limb, the  $W^k$.}
  \label{fig:character}
\end{figure}

\medskip
\textbf{A robot} is a kinematic chain $R$, comprising \mbox{$n + 6$} degrees of freedom (DOFs).
$R$ is composed of $l$ limbs $R^k, 1 \leq k \leq l$, attached to a root.
It is described by a configuration $\mathbf{q} \in SE(3) \times \mathbb{R}^n$.
We define some relevant projections of $\mathbf{q}$:
\begin{itemize}
	\item $\mathbf{q}^k$ denotes the configuration (a vector of joint values) of the limb $R^k$ (Figure~\ref{fig:character});
	\item $\mathbf{q}^{\overline{k}}$ denotes the vector of joint values of R \textbf{not} related to $R^k$. We define for convenience \mbox{$\mathbf{q}= \mathbf{q}^k \oplus \mathbf{q}^{\overline{k}}$}; %Abusively, we denote by $\mathbf{q}^0 \oplus \mathbf{q}^k$ any configuration respecting $\mathbf{q}^0$ and $\mathbf{q}^k$;
	\item $\mathbf{q}^{0}\in SE(3)$ denotes the position and orientation of the root of the robot $R$.
\end{itemize}
%Finally, $ \mathbf{q}_{start}$ and  $\mathbf{q}_{goal}$ are the start and goal configurations given as an input of our problem.

%\subsubsection{Environment and other volumes} 
%\label{sec:A}
\medskip
The volume encompassing the trunk of the robot is denoted $W^0$ (Figure~\ref{fig:character}-right: central cylinder). The reachable workspace of a limb $R^k$ is denoted $W^k$ (Figure~\ref{fig:character}-right: the four ellipses). 
\begin{equation}
  W^k = \left\{ {\mathbf{x} \in \mathbb{R}^3: \exists \, \mathbf{q}^k \in C^k_{jl}, \mathbf{p}^k(\mathbf{q}^k) = \mathbf{x} } \right\},
\end{equation}
%~ \adnote{in this definition you don't account for joint limits}
where $\mathbf{p}^k$ denotes the end-effector position of $R^k$ (translation only) for $\mathbf{q}^0$ being the null displacement, and  $C^k_{jl}$ is the space
of admissible limb joint configurations. We also define $W = \bigcup_{k=1}^{l}W^k$, and
$W^k(\mathbf{q}^{0})$ (for $1 \leq k \leq l$) as the volume $W^k$ translated and rotated by the rigid displacement~$\mathbf{q}^{0}$.

\medskip
\textbf{The environment} $O$ is defined as the union of the obstacles $O_i$ that it contains.
Finally, we define $dist(\mathbf{x}, O)$ as the minimal distance between a point $\mathbf{x}$ and the closest surface of the environment.
