% !TEX root =  ../main.tex
\section{Addressing $\mathcal{P}_3$}
\label{app:optim}
The stair climbing and the standing up scenarios were validated with the trajectory optimization scheme provided in \citeauthor{Carpentier2016}. 
%~ \deladp{The optimization is formulated as an optimal control problem that aims at generating a valid trajectory for the center of mass.}
To address the other scenarios, we propose a new implementation, entirely open source (\url{https://github.com/stonneau/python_sandbox}), which can be integrated directly in our motion planner software. This formulation uses the center of mass acceleration and angular momentum as input variables, while previously the contact forces were used.
The center-of-mass trajectory resulting from the optimization is then turned into a collision-free whole-body trajectory.

We rewrite Eq.~\ref{eq:new_eul} in the general case:

%~ \begin{align} \label{eq:new_eul}
%~ \underbrace{
%~ \mat{\mathbf{I}_3 & \dots & \mathbf{I}_3 \\
%~ \hat{\mathbf{p}}_1 & \dots & \hat{\mathbf{p}}_e} \mathbf{V}
%~ }_\mathbf{G} \bm{\beta}, = 
%~ \underbrace{\mat{\mathbf{0}_{3\times 3} \\ m \hat{\mathbf{g}}}}_{\mathbf{D}} \mathbf{c} + 
%~ \underbrace{\mat{-m\mathbf{g} \\ \mathbf{0}}}_{\mathbf{d}}
%~ \end{align}

\begin{align} \label{eq:new_eul_acc}
\mathbf{G} \bm{\beta} = 
\underbrace{\mat{m (\mathbf{\ddot{c}} - \mathbf{g}) \\m \mathbf{c} \times (\mathbf{\ddot{c}} - \mathbf{g}) + \dot{L}}}_{\mathbf{w}}
%~ \underbrace{m (\mathbf{\ddot{c}} - \mathbf{g})  \\ m (\mathbf{\ddot{dc}} - \mathbf{g}) + \mathbf{\dot{L}} }_{\mathbf{w}}
\end{align}

where $\dot{L}$ is the angular momentum expressed at the com.
Eq.~\ref{eq:new_eul_acc} defines a 6-dimensional cone $\mathcal{K}$ ~\citep{qiu:dhm:2011,Caron2015}. For a given set of contacts,
this cone determines all the admissible wrenches $\mathbf{w}$ that can be generated by contact forces inside their friction cones.
The face form of $\mathcal{K}$ can be computed using the double description method~\citep{Fukuda1996}, resulting in the following linear inequalities:

\begin{equation}
\label{eq:cone_k}
	\mathcal{K} =  \left\{ \mathbf{w}, \mathbf{A}\mathbf{w} \leq \mathbf{b	} \right\}
\end{equation}

The objective 
is then to plan a trajectory for the center of mass such that the generated $\mathbf{w}$ always verifies Eq.~\ref{eq:cone_k}. 
We now consider two contact configurations  $\mathbf{q}_0$ and $\mathbf{q}_1$ computed by our planner: in the general case one contact is broken and one created to get from
$\mathbf{q}_0$ to $\mathbf{q}_1$. We manually define the duration of each of the three contact phases.
In each phase $s$ the centroidal wrench $\mathbf{w}$ is constrained to lie inside a cone $\mathcal{K}_u, u =0 \dots 2$.
We call the total duration of the motion $T$, and formulate the following optimization problem:

\begin{equation} \label{eq:lin_prog_rob} \begin{aligned}
%~ \find \quad & \mx{R} \in \Rv{3\times T}, \mxdd{C} \in  \Rv{6\times T} \\
\minimize_{\mathbf{c}(t), \mathbf{\dot{c}}(t), \mathbf{\ddot{c}}(t), \mathbf{w}(t)}  \quad & \sum_{u=0}^{2} \int_{t_u}^{t_u + \Delta t_u}  \ell(\mathbf{c}(t), \mathbf{\dot{c}}(t), \mathbf{\ddot{c}}(t), \mathbf{w}(t)) \text{dt}  \\
\st \quad & \mathbf{\ddot{c}}(t) = dyn(\mathbf{c}(t), \mathbf{\dot{c}}(t), \mathbf{w}(t)) \\
	\quad & \mathbf{A}_u \mathbf{w}(t)  \leq \mathbf{b}_u , \forall t \in  \left[t_u, t_u + \Delta t_u \right[, \forall u \\
	\quad & \mathbf{Y}_u \mathbf{c}(t)  \leq \mathbf{y}_u , \forall t \in  \left[t_u, t_u + \Delta t_u \right[, \forall u \\
	\quad & \mathbf{c}(0)  = \mathbf{c}_{\mathbf{q}_0} \\
	\quad & \mathbf{c}(T)  = \mathbf{c}_{\mathbf{q}_1} \\
	\quad & \mathbf{c}(0)  = \mathbf{\dot{c}}(0)  = \mathbf{\ddot{c}}(0) = \mathbf{0}\\
	\quad & \mathbf{c}(T)  = \mathbf{\dot{c}}(T)  = \mathbf{\ddot{c}}(T) = \mathbf{0}\\
    %~ \quad & ({\vct{r}}\tra\vct{r}=1,  \forall t  ?) \\
    %~ \quad & \delta t \sum\limits_1^{T-1}{\vc{r}^1}\tra {\vc{r}^1} \ge t_{transit} \\
    %~ \quad & \mx{A}_{\int} \mxdd{C} \leq \vc{a}_{\int} \\
    %~ \quad & \mx{V}_{\int} \mxd{C} \leq \vc{v}_{\int} \\
    %~ \quad & \mx{B}_{\int}^{1} \mx{C} \leq \vc{b}_{\int} \\
    %~ \quad & [\vc{c}_0\tra, \vcd{c}_0\tra]\tra = \vc{x}_0 \\
    %~ \quad & \vc{c}_T = \vc{c}_T^{input} \\
\end{aligned} \end{equation}

The cost function $\ell$ is a weighted sum of the angular momentum and center-of-mass acceleration variation over the whole trajectory. 
The system dynamics $dyn$ tie together the position, velocity and acceleration of the center of mass. 
$\mathbf{Y}_u$ and $\mathbf{y}_u$ denote stacked kinematic constraints on the center of mass position, determined by the active contact locations.
The inequalities for each contact are determined in the same way that the reachable workspace is computed in Appendix~\ref{app:rom}, with
the effector serving as root. % (a triangulated object is a polytope, and as such can be described as a set of linear inequalities).

This formulation can trivially be extended over the whole contact sequence.
In our implementation, the problem is discretized using time steps of 100 ms. 

The output of this optimization problem is an admissible center-of-mass trajectory.
To compute the whole body motion, we use a two-step approach.

First, we plan a kinematic motion for the robot, subject to the contact constraints. We also constrain the center of mass to follow
the computed trajectory. This is achieved using a constraint-based RRT planner~\citep{7759083}. As a result we obtain a collision-free whole-body motion.

The entire resolution takes approximatively 1.5 seconds for a complete contact transition.

This motion is then validated in our dynamic simulator~\citep{DelPrete2015b}, using the trajectory as a reference postural task for an inverse-dynamics
controller that accounts for all the robot constraints. This final result is shown in the companion video.
