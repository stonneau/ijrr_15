% !TEX root =  ../main.tex

Planning legged robot locomotion in a complex environment (stairs, constraining obstacles, uneven surfaces \dots) remains an open issue.
To move, a legged robot is required to sequentially create contacts with the environment while avoiding collisions. Finding such a contact sequence is an instance of the motion planning problem called acyclic contact planning.

Addressing this issue is a pre-requisite to the deployment of robots in human-centered environments, where wheeled robots are not able to navigate. 

To make a legged robot walk on a flat ground, efficient approaches based on the capture point~\citep{Pratt2006} can be used to determine the contact location. Choosing the effector
to create a contact with is also trivial because walk follows a cyclic pattern.
Unfortunately, in the general case planning complex contact interactions is extremely challenging because the determinism disappears.
At any given time a contact choice must be made between infinitely many possibilities (often a combinatorial discrete choice for the effector, and an infinite choice for the location). Furthermore, the contact manifold is foliated~\citep{simeon-manipulation-04}: a contact choice constrains kinematically and dynamically the possible motions, and there is no analytical way to verify whether this decision brings the robot one step closer to the desired goal or to a dead end, especially in the presence of obstacles. Lastly, the contact manifold has a null measure and is thus impossible to randomly sample.


%~ This makes the simultaneous planning of a center of mass trajectory with a contact sequence tedious.


 %~ The contact manifold can be seen as a building with an infinite number of floors and elevators, where each elevator only stops at a subset of the floors. We don't have a map of this building. In this metaphor, the kinematic and dynamic constraints associated with a contact configuration restrict the motion to lie on
%~ a floor, until an elevator can be reached, to safely transition to another floor (ie a new contact configuration). Exploring efficiently the building to find 
%~ the sequence of floor paths and elevator transitions is the scientific question to address.
 %~ Furthermore, because the contact manifold has a zero measure in the configuration space, we can't sample a configuration that lie on a floor.

%~ This contact manifold has a null measure, which makes it impossible to directly sample contact configurations. Even worse, 
%~ the contact manifold is foliated~\citep{simeon-manipulation-04}: each contact decision creates kinematic and dynamic constraints that must 
%~ be respected to transition to another state. 

%~ Contact interaction is crucial to maintain equilibrium, though extremely challenging:
%~ \begin{enumerate}
%~ \item verifying that a contact allows the motion to be continuously dynamically feasible is computationally expensive; 
%~ \item the contact manifold has a zero measure (a contact configuration cannot be sampled);
%~ \item the choice of contacts along the motion (e.g. left or right hand) adds a combinatorial issue, and the set of possible contact locations is infinite; 
%~ \item kinematic constraints appear upon contact creation, introducing an infinite foliation of the contact manifold~\citep{simeon-manipulation-04};
%~ \item in theory, maintaining the balance of the robot requires the simultaneous planning of the root trajectory and the contact locations and timing, which increases even more the search space.
%~ \end{enumerate}
%~ Most locomotion systems avoid these issues thanks to simplifying assumptions that reduce the complexity (coplanar contacts, cyclic patterns that are not combinatorial)~\citep{Kajita03a}.
For this reason at the DARPA challenge, instead of using the environment for creating contacts that facilitate motion, the chosen strategies fell back to walking patterns, and avoided obstacles as much as possible~\citep{atkensondarpa}, resulting in unsafe behaviors. 
Previous contributions having demonstrated acyclic contact locomotion have not been used because they are either too computationally expensive~\citep{Bretl:2006:MPM:1124573.1124585} or dynamically inconsistent~\citep{Mordatch:2012:DCB:2185520.2185539}.

In this paper, we propose a pragmatic approach to tackle the complexity of the acyclic contact planning problem. Rather than planning simultaneously in the configuration space the 
whole-body trajectory and the contact location and timings, we decouple path and contact planning, as suggested by \citeauthor{Bouyarmane2009}.
We first plan a path for the geometric root of the robot in a low dimensional space. We formulate this space as a computationally-efficient approximation
of the \textit{equilibrium feasibile} space, that is the space of root configurations for which there exists a joint configuration such that the robot is in static equilibrium.
We then use a deterministic algorithm 
%~ We introduce a computationally-efficient condition for \glslink{equilibrium feasible}{\textit{equilibrium feasibility}} of a root configuration (i.e. there exists a joint configuration such that the robot is in static equilibrium).
%~ We claim that this can be done at a much smaller cost, provided we can formulate a computationally-efficient condition for \glslink{equilibrium feasible}{\textit{equilibrium feasibility}} of a root configuration (i.e. there exists a joint configuration such that the robot is in static equilibrium).
This paper presents a geometrical approximation of this condition, and a concrete implementation of such a decoupled planner.
This approximation results from a trade-off between a necessary and a sufficient condition for \textit{equilibrium feasibility}, allowing us to find solutions extremely rapidly, while preserving a high success rate in the demonstrated scenarios.

%~ In the remainder of this introduction, we discuss further the current state of the art. This allows us to situate more precisely our contributions.

\subsection{State of the art}

\newcommand{\Pa}{$\mathcal{P}_1$ }
\newcommand{\Pb}{$\mathcal{P}_2$ }

Additionally to robotics, acyclic motion planning is also a problem of interest in neurosciences, biomechanics, and virtual character animation.
Early contributions in the latter field rely on local adaptation of motion graphs \citep{citeulike:220163}, or ad-hoc construction of locomotion controllers \citep{Pettre:2003:LPD:846276.846313}. These approaches are intrinsically not able to adapt to new situations or discover complex behaviors in unforeseen contexts.

The issue of planning acyclic contacts was first completely described by Bretl et al. in their seminal paper  \citep{Bretl:2006:MPM:1124573.1124585}. The issue requires the simultaneous handling of two problems, $\mathcal{P}_1$: planning a relevant guide path for the root of the robot in $SE(3)$; and $\mathcal{P}_2$: planning a discrete sequence of acyclic equilibrium configurations along the path. A third nontrivial problem, $\mathcal{P}_3$, not addressed in this work, then consists in interpolating a complete motion between two postures of the contact sequence.  A key issue is to avoid combinatorial explosion when considering at the same time the possible contacts and the potential paths. This seminal paper proposes a first effective algorithm, able to handle simple situations (such as climbing scenarios), but not applicable to arbitrary environments. Following it, seve\-ral papers have applied this approach in particular situations, typically limiting the combinatorial by imposing a fixed set of possible contacts \citep{Hauser06usingmotion, stilman2010}.

Most of the papers that followed the work of \citeauthor{Bretl:2006:MPM:1124573.1124585} have explored alternative formulations to handle the combinatorial issue. Two main directions have been explored. \textbf{On one hand, local optimization of both the root trajectory \Pa and the contact positions $\mathcal{P}_2$} has been used, to trade the combinatorial of the complete problem for a differential complexity, at the cost of local convergence. A complete example of the potential offered by such approaches was proposed \citep{Mordatch:2012:DCB:2185520.2185539} and successfully applied to a real robot \citep{mordatch2015}. To keep reasonable computation times, the method uses a simplified dynamic model for the avatar. Still, the computation time is far from real-time  (about 1 minute of computation for a sequence of 20 contacts).  A similar approach has been considered for manipulation by \cite{gabicciniisrr15}. \citeauthor{DBLP:conf/humanoids/DeitsT14} propose to solve contact planning globally as a mixed-integer problem, but only cyclic, bipedal locomotion is considered. 
\citeauthor{dai2014whole} extend the work of \citeauthor{Posa:2014:DMT:2568343.2568352} to discover the contact sequence for landing motions, but need to specify
the contacts manually for more complex interactions.
In addition to the practical limits of the current implementations, a major drawback of these optimization-based approaches is that they only offer local convergence when applied to acyclic contact planning.

\textbf{On the other hand, the two problems \Pa and \Pb might be decoupled} to reduce the complexity. The feasibility and interest of the decoupling is shown by \citeauthor{DBLP:conf/iser/EscandeKMG08} who manually set up a rough root guide path (i.e. an ad-hoc solution to $\mathcal{P}_1$). \Pb is addressed as the combinatorial computation of a feasible contact sequence in the neighborhood of the guide. A solution can then be found, %efficiently when considering quadruped locomotion \citep{kalakrishnan2011learning}, 
but at the cost of prohibitive computation times (up to several hours) for constraining scenarios. This approach is suboptimal because the quality of the motion depends on the quality of the guide path. \citeauthor{Bouyarmane2009} precisely focus on automatically computing a guide path with guarantees of \glslink{equilibrium feasible}{\textit{equilibrium feasibility}}, by extending key frames of the path into whole-body configurations in static equilibrium. Randomly-sampled configurations are projected into the contact sub-manifold using a inverse-kinematics solver, a computationally-expensive process (about 15 minutes to compute a guide path in the examples presented). Moreover this explicit projection is insufficient to guarantee the feasibility between two key positions in the path. \citeauthor{7140082} also propose a decoupled approach, with a planning phase based on the reachable workspace of the robot limbs, used to judge the ability to make contact with 
a discretized environment. This planning phase does not account for collisions, implying that replanning is required in case of failure. This approach is efficient 
in the demonstrated scenarios. In highly-constraining cases such 
as the car egress scenario that we address here, we believe that including collision constraints in the planning is a requirement.

For completeness, we lastly mention a new kind of approach, recently proposed in the computer graphics field \citep{hamalainen_cpbp_2015}. The authors
use black-box physics simulators to perform Model Predictive Control for the motion of a humanoid character, and manage to obtain dynamically consistent motions
at \gls{interactive} frame rates (we say that a planning method is interactive when the computation time for one contact switch is less than the
time to execute it). While this new approach provides an exciting direction of research, currently the resulting motions
look unnatural, and do not seem applicable to real robots.

As far as robotics applications are concerned, none of the existing planners is able to solve the problem with \gls{interactive} performances.
However, recent contributions to the interpolation between contact poses (problem $\mathcal{P}_3$) have brought promising preliminary solutions \citep{Hauser2014, herzog2015trajectory, Park116, Carpentier2016}. In particular, \citeauthor{Carpentier2016} are able to achieve this with \gls{interactive} performances on a real robot.
Therefore, a planner capable of efficiently solving \Pa and \Pb could outperform all existing planners if coupled with an interpolation method solving $\mathcal{P}_3$.
The main contribution of this paper is exactly this planner.

\subsection{Situation and Contributions}

\begin{figure*}
  \centering
  \begin{overpic}[width=0.8\linewidth]{figures/workflow}
    %~ \put (6.4,1.8) {\normalsize{Request}} 
    \put (30,10.8) {\large{\color{white}\Pa} }
    %~ \put (31.6,2) {\scriptsize{\color{white}RB-RRT}} 
    \put (66.4,10.8) {\large{\color{white}\Pb} }
    %~ \put (72.5,2) {\tiny{\color{white}Contact}} 
  \end{overpic}
  \vspace{-1em}
  \caption{
    Overview of our two-stage framework. Given a path request between start and goal positions (left image), \Pa is the problem of computing a guide path in the space
    of \textit{equilibrium feasible} root configurations. We achieve this by defining a geometric condition, the \textit{reachability condition} (abstracted with the transparent cylinders on the middle image). \Pb is then the problem of extending the path into a discrete sequence of contact configurations using an iterative algorithm (right image).}
  \label{fig:framework}
\end{figure*}

Our solution belongs the class of decoupled approaches, because we believe that the separation between the generation of the root guide path and the contact sequence is the most promising direction \citep{DBLP:conf/iser/EscandeKMG08} to break the complexity of multi-contact planning. Compared to previous approaches, our solution has two main novelties: 

\noindent \textbf{Regarding $\mathcal{P}_1$}, we define and use the \textit{reachability condition} to plan the guide path. The \textit{reachability condition}, a computationally-efficient approximation of the \glslink{equilibrium feasible}{\textit{equilibrium feasibility}}. This step is fast because the planning happens
in a low-dimensional space, and does not require explicit contact computations.

\noindent \textbf{Regarding $\mathcal{P}_2$},  we address \Pb by extending the path into a sequence of whole-body configurations in static equilibrium. This second step requires the explicit computation of contact configurations. It is guided by dedicated heuristics which fastly synthesize relevant configurations.

This sequential approach is the key to the efficiency of our method, though it
can result in failures because our hypothesis is not always true. However, we demonstrate empirically the validity of the approach: the high success rate, combined with the low computation times, allow us to plan (and re-plan upon failure) multi-contact sequences at \gls{interactive} rates.

As a result, we propose contributions to both problems \Pa and $\mathcal{P}_2$.
\begin{itemize}
\item A low-dimensional, efficient sampling-based approach to plan guide paths.
\item A very efficient and general implementation of an acyclic contact planner, the first one compatible with \gls{interactive} applications.
\item Four heuristics for contact generation. They bias the planner towards configurations that are in robust static equilibrium, or 
more efficient with respect to the task.
\end{itemize}


%
%
%% TO BE MOVED IN DISCUSSION 
%%
%%the guide path must guarantee the existence of a contact sequence to actuate it. We call this property \glslink{equilibrium feasible}{\textit{equilibrium feasibility}}. This property has not been studied yet; the only rigorous way to validate a waypoint in the path is to explicitly compute the contact locations and forces, which is computationally not reasonable \citep{Bouyarmane2009}, unless the scenario is limited to cyclic, quasi-flat cases \citep{zucker2010optimization}. \\
%
%\noindent \textbf{Regarding $\mathcal{P}_2$}, there are infinitely many combinations of possible contact sequences for a given root path. The selection of one particular contact sequence with interesting properties (minimum number of contact changes, robustness, efficiency or naturalness) has been studied for cyclic cases \citep{Hauser06usingmotion}, but has not been efficiently applied to constraining environments (\citeauthor{bouyarmane:lirmm-00777727} and \citeauthor{DBLP:conf/iser/EscandeKMG08} mostly randomly picked one contact sequence, possibly leading to very tedious transitions).  \\
%
%
%\textbf{The key idea of the paper is the \textit{reachability condition}}, a computationally-efficient approximation of the \glslink{equilibrium feasible}{\textit{equilibrium feasibility}}.
%We assume that most of the times the \textit{reachability condition} implies the \glslink{equilibrium feasible}{\textit{equilibrium feasibility}}.
%%root configurations in this approximation can be efficiently extended into full body configurations in static equilibrium.
%This assumption is not always verified, but we provide empirical evidence that it is in the considered class of problems, the \textit{\gls{cluttered} contact planning problems}.
%Such problems can be solved with a contact sequence 
%where in every configuration at least one contact is \gls{quasi-flat}~\citep{Prete2016}. A contact is \textit{quasi-flat} if the friction cone contains the direction opposite to gravity. 
%%~ This definition includes motions on flat or uneven terrains, but also more complex ones such as stair climbing, car egress, or standing up scenarios, that might require noncoplanar contacts.
%%Under this assumption we can take advantage of the decoupling approach to find a solution rapidly.
%
%%Similarly, in this paper we do not  prove that all the contact sequences produced by our planner can be interpolated ($\mathcal{P}_3$), although we have been able to do this for some of the demonstrated sequences~\citep{Carpentier2016}.   
%
%
%To address $\mathcal{P}_1$, we first use the \textit{reachability condition} to plan the guide path. This step is fast because the planning happens
%in a low-dimensional space, and does not require explicit contact computations.
%
%Then we address \Pb by extending the path into a sequence of whole-body configurations in static equilibrium.
%This second step requires the explicit computation of contact configurations.

%
%
%\subsection{Paper contribution and organization}
%We propose contributions to both problems \Pa and $\mathcal{P}_2$.
%\begin{itemize}
%\item A low-dimensional, efficient sampling-based approach to plan guide paths.
%\item A very efficient and general implementation of an acyclic contact planner, the first one compatible with \gls{interactive} applications.
%\item Four heuristics for contact generation. They bias the planner towards configurations that are in robust static equilibrium, or 
%more efficient with respect to the task.
%\item Statistical tests that empirically demonstrate the validity of our approach in the considered scenarios. 
%\end{itemize}
%
%%Compared to previous work \citep{Mordatch:2012:DCB:2185520.2185539} our planner does not produce a complete motion, but a discrete sequence of contacts.
%%Since the interpolation of a complete path between such configurations can be solved within \gls{interactive} constraints \citep{Carpentier2016}, we claim that our planner is the fastest multi-contact planning solution to our knowledge.
%
%
%In Section~\ref{overview}, we present an overview of our method. Section~\ref{rbprm} and Section~\ref{sec:contact} present respectively our answer to \Pa and $\mathcal{P}_2$. In Section~\ref{sec:heuristics}, we present heuristics used for the selection of a contact configuration. Finally, in Section 6 we propose a complete experimental validation of the planner with three very different kinematic chains (the HRP-2 and HyQ robots, and a three-finger manipulator) in various scenarios.
%%that complete those presented in the conference paper.
%
%\subsection*{Comparison with our previous work}
%The present paper is an extension of a conference paper to appear in the proceedings of the ISRR'15 conference~\citep{tonneauisrr15}.
%The conference paper focuses on the theoretical formulation of the problem, and presents results obtained with virtual avatars.
%This extension completes this work and brings new contributions, resulting from the implementation of our approach on real-world robots and problems.
%In particular, a strong contribution is the introduction of a robust equilibrium criterion, designed to ensure the equilibrium of the robot despite bounded errors in the contact forces, coupled
%with heuristics for relevant contact selection. These two contributions were required to apply our method to real-robot models, namely HRP-2 and HyQ~\citep{semini11hyqdesignjsce}.
%In the present paper, a complete algorithm for the contact planner is given, and an access to the source code of our implementation is provided.
%Furthermore, our experiments are supported by an in-depth analysis of our performances, as well as a discussion on the influence of the parameters to the method.

