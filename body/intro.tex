% !TEX root =  ../main.tex
\newcommand{\Pa}{$\mathcal{P}_1$ }
\newcommand{\Pb}{$\mathcal{P}_2$ }

%~ Planning legged robot locomotion remains an open issue.
\IEEEPARstart{L}{egged} robots move by sequentially creating contacts with the environment.
After years of research, such robots can autonomously walk on flat ground, but struggle to navigate in more complex environments, where deciding where to create a contact with its feet and possibly its hands is nontrivial, e.g. to climb stairs using a handrail.
%In such a case a humanoid robot must plan the contacts it musts create with its feet and hands.
Computing such a movement is an open motion-planning problem called acyclic contact planning.
Most of the complexity of this problem lies in the choice of the sequence of contacts, i.e. the underlying decomposition of the trajectory into contact phases where specific points of the robot body are exerting forces on specific locations of the environment.
Tackling this complexity is the main objective of this paper.
%
Once the contact plan is known, efficient approaches exist to generate a dynamically feasible motion~\citep{Carpentier2016}. 

%% However in general
%% the contact plan is manually designed by a time consuming trial-and-error procedure. Automatically addressing the acyclic contact planning problem is thus a pre-requisite to the deployment of robots in cluttered, human-centered environments, which comprise constraining obstacles (stairs...).

In the specific (and simple) case of gaited biped locomotion on flat ground, choosing the effector with which to create a contact is trivial because walking follows a cyclic pattern (left foot always follows right foot).
Efficient tools such as the capture point~\citep{Pratt2006} can be used to compute the next contact location. 
%
The general case of planning contact sequences is more challenging.
At any given time a contact results of a combinatorial discrete choice for both the effector and contact surface, and a continuous choice for the contact location.
Any choice of contact then kinematically and dynamically constrains the possible motion of the robot.
Furthermore there is no analytical way to verify whether this choice brings the robot one step closer to the desired goal or to a dead end, especially in the presence of obstacles.
From this property, we say that the contact manifold is foliated~\citep{simeon-manipulation-04}. 
The foliation prevents the use of efficient sampling-based planners for two reasons.
(i) First, each submanifold of the foliation has a zero measure and cannot be directly sample.
A sample is rather obtained by sampling a ``free flying'' configuration and explicitly projecting it in contact (which is a costly numerical operation).
(ii) Second, the foliated topology turns the exploration by spreading a graph of configurations (probability roadmap, rapidely exploring random trees) into an unefficient random process, where many useless nodes are sampled on parallel submanifolds.
The total algorithm complexity of classical contact planners comes both from the number of nodes of the graph that are sampled during the exploration (ii) and to the cost of the projection when sampling a new configuration (i).
%
For this reason previous contributions having demonstrated acyclic contact locomotion on a real robot are too computationally expensive~\citep{Bretl:2006:MPM:1124573.1124585}. As a result at the DARPA Robotics Challenge, the participants stated that the robots did not use multi contact strategies (except for egress): they relied on unsafe bipedal walking to climb stairs, instead of using the provided handrails to facilitate the motion~\citep{atkensondarpa}. 


%Obtaining reasonable computation times is critical for a contact planner to be of any practical use. 
Our work aims at breaking the complexity of the acyclic contact planning problem.  
To do so we deal sequentially with the two main issues associated to our problem: the null measure of the contact manifold (i), and the combinatorics of the contact selection problem (ii). 
To that end, we introduce a reduction property: the \textit{reachability condition}.
This condition relaxes the strict contact condition.
It induces a low-dimensional space, called the \textit{contact reachable} space, that has Cartesian topology, i.e. it can be efficiently sampled.
Under some hypothesis, a path in the \textit{contact reachable} space can be easily mapped to the (high-dimensionnal) contact manifold. 
This approach enables us to separate the contact planning problem in two tractable subproblems.
This decoupling presents pros and cons discussed in previous related literature, summarized in the following.
%~ whole-body trajectory and the contact location and timings, we decouple path and contact planning, as suggested by \citeauthor{Bouyarmane2009}.
%~ We first plan a path for the geometric root of the robot in a low dimensional space. We formulate this space as a computationally-efficient approximation
%~ of the \textit{equilibrium feasibile} space, that is the space of root configurations for which there exists a joint configuration such that the robot is in static equilibrium.
%~ We then use a deterministic algorithm
%~ This paper presents a geometrical approximation of this condition, and a concrete implementation of such a decoupled planner.
%~ This approximation results from a trade-off between a necessary and a sufficient condition for \textit{equilibrium feasibility}, allowing us to find solutions extremely rapidly, while preserving a high success rate in the demonstrated scenarios.

%~ In the remainder of this introduction, we discuss further the current state of the art. This allows us to situate more precisely our contributions.

\begin{figure*}
  \centering
  \begin{overpic}[width=0.8\linewidth]{figures/workflow}
    %~ \put (6.4,1.8) {\normalsize{Request}} 
    \put (30,10.8) {\large{\color{white}\Pa} }
    %~ \put (31.6,2) {\scriptsize{\color{white}RB-RRT}} 
    \put (66.4,10.8) {\large{\color{white}\Pb} }
    %~ \put (72.5,2) {\tiny{\color{white}Contact}} 
	\put (15,1) {a} 
	\put (50,1) {b} 
	\put (85,1) {c} 
  \end{overpic}
  \vspace{-1em}
  \caption{
    Overview of our two-stage framework. Given a path request between start and goal positions (left image), \Pa is the problem of computing a guide path in the space
    of \textit{equilibrium feasible} root configurations. We achieve this by defining a geometric condition, the \textit{reachability condition} (abstracted with the transparent cylinders on the middle image). \Pb is then the problem of extending the path into a discrete sequence of contact configurations using an iterative algorithm (right image).}
  \label{fig:framework}
\end{figure*}


\subsection{State of the art}



Additionally to robotics, acyclic motion planning is also a problem of interest in neurosciences, biomechanics, and virtual character animation.
Early contributions in the latter field rely on local adaptation of motion graphs \citep{citeulike:220163}, or ad-hoc construction of locomotion controllers \citep{Pettre:2003:LPD:846276.846313}. These approaches are by definition not able to discover complex behaviors in unforeseen contexts.

The issue of planning acyclic contacts was first completely described by Bretl~\cite{Bretl:2006:MPM:1124573.1124585}. The issue requires the simultaneous handling of two sub-problems, $\mathcal{P}_1$: planning a guide path for the root of the robot in $SE(3)$; and $\mathcal{P}_2$: planning a discrete sequence of equilibrium configurations along the path. A third nontrivial problem, $\mathcal{P}_3$, 
%~ not addressed in this work, 
then consists in interpolating a complete motion between two postures of the contact sequence.  A key issue is to avoid combinatorial explosion when considering at the same time the possible contacts and the potential paths. Bretl's seminal paper proposes a first effective algorithm, able to handle simple situations (such as climbing scenarios), but not applicable to arbitrary environments. Following it, seve\-ral papers have applied this approach in specific situations, limiting the combinatorial by imposing a fixed set of possible contacts \citep{Hauser06usingmotion, stilman2010}.

Most of the papers that followed the work of Bretl have explored alternative formulations to handle the combinatorics. Two main directions have been explored. \textbf{On the one hand, local optimization of both the root trajectory \Pa and the contact positions $\mathcal{P}_2$} has been used, to trade the combinatorial of the complete problem for a differential complexity, at the cost of local convergence \citep{1631739}. A complete example of the potential offered by such approaches was proposed by \cite{Mordatch:2012:DCB:2185520.2185539} and successfully applied to a real robot \citep{mordatch2015}. To get reasonable computation times, the method uses a simplified dynamic model for the avatar. Still, the method is far from real-time  (about 1 minute of computation for 20 contacts).  A similar approach has been considered for manipulation by \cite{gabicciniisrr15}. Deits and Tedrake proposed to solve contact planning globally as a mixed-integer problem, but only cyclic, bipedal locomotion is considered, and equilibrium is not considered~\cite{DBLP:conf/humanoids/DeitsT14}. 
Dai et al.~\cite{dai2014whole} extended the work of Posa et al.~\cite{Posa:2014:DMT:2568343.2568352} to discover the contact sequence for landing motions, but need to specify
the contacts manually for complex interactions.
In addition to the limits of the current implementations, optimization-based approaches only converge locally.

\textbf{On the other hand, the two problems \Pa and \Pb might be decoupled} to reduce the complexity. The feasibility and interest of the decoupling has been shown by Escande et al. \cite{DBLP:conf/iser/EscandeKMG08} who manually set up a rough root guide path (i.e. an ad-hoc solution to $\mathcal{P}_1$), and then addressed \Pb as the combinatorial computation of a feasible contact sequence in the neighborhood of the guide. A solution could then be found, %efficiently when considering quadruped locomotion \citep{kalakrishnan2011learning}, 
but at the cost of prohibitive computation times (up to several hours) for constraining scenarios. This approach is suboptimal because the quality of the motion depends on the quality of the guide path. Bouyarmane et al. ~\cite{Bouyarmane2009} precisely focused on automatically computing a guide path with guarantees of \textit{equilibrium feasibility}, by extending key frames of the path into whole-body configurations in static equilibrium. Randomly-sampled configurations are projected to the contact manifold using an inverse-kinematics solver, a computationally-expensive process (about 15 minutes to compute a guide path in the examples presented). Moreover this explicit projection is insufficient to guarantee the feasibility between two key postures in the path. Chung and Khatib~\cite{7140082} also proposed a decoupled approach, with a planning phase based on the reachable workspace of the robot limbs, used to judge the ability to make contact with a discretized environment. This planning phase does not account for collisions, implying that replanning is required in case of failure. In highly-constraining cases such as the car egress scenario we address, we believe that including collision constraints in the planning is a requirement~\citep{tonneauisrr15,grey2017footstep}.

For completeness, we lastly mention a new kind of approach, recently proposed in the computer graphics field \citep{hamalainen_cpbp_2015}. The authors
used black-box physics simulators to perform Model Predictive Control for a humanoid character, and managed to obtain dynamically-consistent motions
at \gls{interactive} frame rates\footnote{We say that a method is \underline{interactive} when the computation time for planning is less than the
execution time.}. While this new approach provides an exciting direction of research, currently the resulting motions
 do not seem applicable to real robots.

As far as robotics applications are concerned, none of the existing planners is \gls{interactive}.
However, recent contributions to the interpolation between contact poses (problem $\mathcal{P}_3$) have brought promising preliminary solutions \citep{Hauser2014, herzog2015trajectory, Park116, Carpentier2016}. In particular, our algorithm proposed in \cite{Carpentier2016} is \gls{interactive}.
Therefore, a planner capable of efficiently solving \Pa and \Pb could outperform all existing planners if coupled with an interpolation method solving $\mathcal{P}_3$.
The main contribution of this paper is exactly this planner.


\subsection{Contributions}

Our solution belongs to the class of decoupled approaches, because we believe it is the most promising direction~\citep{DBLP:conf/iser/EscandeKMG08} to break the complexity of acyclic contact planning. Compared to previous approaches, our solution has two main novelties: 

\noindent \textbf{Regarding $\mathcal{P}_1$}. We propose a fast guide path planning algorithm. The key to its efficiency is that it does not sample directly the contact manifold, but an approximation of the \textit{contact reachable} space. The \textit{contact reachable} space is a low-dimensional space for which there exists a mapping to the contact manifold.

\noindent \textbf{Regarding $\mathcal{P}_2$},  we propose a fast method to extend a \textit{contact reachable} path into a sequence of whole-body configurations in static equilibrium. This  requires the explicit computation of contact configurations. It is guided by dedicated heuristics that quickly synthesize feasible configurations.

This sequential approach is the key to the efficiency of our method, though it
can result in failures. However, we demonstrate empirically its interest: the high success rate and low computation times allow us to plan (and re-plan upon failure) multi-contact sequences at \gls{interactive} rates.

To further demonstrate the validity of our approach, we show that the generated contact plans  can be successfully executed (problem  $\mathcal{P}_3$), either in simulation or on the real HRP-2 robot. For HRP-2, we detail the complete computation times to address sequentially the three problems, and compare them to related work, demonstrating that our method is orders of magnitude faster.

Finally, we provide an extensive discussion on the consequences of our approach in terms of efficiency and completeness regarding the contact planning problem. 

This paper extends our previous conference paper~\citep{tonneauisrr15} in several ways. Our approach is now demonstrated on actual robots and in simulation, contrary to virtual avatars before, in a large variety of contexts. To achieve this we introduce a new criterion to efficiently compute the equilibrium of the robot while accounting for uncertainties of the real world. We provide the complete pseudo code of algorithm. We give the complete procedure to use our planner with any legged robot and provide our source code, allowing any user to directly use our method. We also propose a solution to $\mathcal{P}_3$, making our framework complete. Finally we provide an in-depth analysis of the results we obtain, and a theoretical discussion on the capabilities of the planner and its current limitations.
